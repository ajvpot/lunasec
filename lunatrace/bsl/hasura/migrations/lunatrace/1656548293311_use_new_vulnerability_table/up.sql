ALTER TABLE "public"."findings" DROP CONSTRAINT "findings_vulnerability_id_fkey",
  ADD CONSTRAINT "findings_vulnerability_id_fkey"
  FOREIGN KEY ("vulnerability_id")
  REFERENCES "vulnerability"."vulnerability"
  ("id") on update no action on delete no action;

ALTER TABLE "public"."ignored_vulnerabilities" DROP CONSTRAINT "ignored_vulnerabilities_vulnerability_id_fkey",
  ADD CONSTRAINT "ignored_vulnerabilities_vulnerability_id_fkey"
  FOREIGN KEY ("vulnerability_id")
  REFERENCES "vulnerability"."vulnerability"
  ("id") ON UPDATE NO ACTION ON DELETE CASCADE;

ALTER TABLE "public"."findings" ALTER column "vulnerability_id" SET NOT NULL;

ALTER TABLE "public"."guide_vulnerabilities" DROP CONSTRAINT "guide_vulnerabilities_vulnerability_id_fkey",
  ADD CONSTRAINT "guide_vulnerabilities_vulnerability_id_fkey"
  FOREIGN KEY ("vulnerability_id")
  REFERENCES "vulnerability"."vulnerability"
  ("id") ON UPDATE NO ACTION ON DELETE CASCADE;

ALTER TABLE "vulnerability"."equivalent" ALTER column "a" SET NOT NULL;

ALTER TABLE "vulnerability"."equivalent" ALTER column "b" SET NOT NULL;

ALTER TABLE "vulnerability"."vulnerability" ADD COLUMN "cvss_score" REAL NULL;

CREATE OR REPLACE VIEW public.default_branch_builds AS
SELECT build.*
FROM public.builds AS build
JOIN public.projects AS project
    ON project.id = build.project_id
JOIN public.github_repositories AS github_repository
    ON project.id = github_repository.project_id
WHERE build.git_branch = github_repository.default_branch
AND EXISTS(SELECT 1 FROM public.scans WHERE build_id = build.id);
