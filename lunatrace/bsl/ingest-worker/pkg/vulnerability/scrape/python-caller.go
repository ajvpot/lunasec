package scrape

import (
	"encoding/json"
	"fmt"
	"os"
	"os/exec"
	"path/filepath"

	"github.com/rs/zerolog/log"
)

type Result struct {
	// Define your JSON result struct here
}

func callPython(pythonFile string, argString string) (out string, err error) {
	cwd, err := os.Getwd()
	absPath, err := filepath.Abs(cwd)
	if err != nil {
		fmt.Println("Error getting absolute path:", err)
		return
	}
	pyPath := filepath.Dir(absPath)
	baseCmd := fmt.Sprintf("pipenv run python %s/ml/python%s %s", pyPath, pythonFile, argString)

	cmd := exec.Command("pipenv", baseCmd)
	cmd.Path = pyPath

	bytesOut, err := cmd.Output()
	if err != nil {
		log.Error().Err(err).Msg("Failed to call python script")
		return
	}
	out = string(bytesOut)
	println(out)
	return
}

func CleanScrapedAdvisory(contents string, vulnDescription string) (out string, err error) {
	pythonFile := "/scrape_utils/clean_scraped_advisories.py"

	escapedContents, err := json.Marshal(contents)
	if err != nil {
		return
	}
	escapedDescription, err := json.Marshal(vulnDescription)
	if err != nil {
		return
	}
	argString := fmt.Sprintf("\"%s\" \"%s\"", escapedContents, escapedDescription)
	stringOutput, err := callPython(pythonFile, argString)
	return stringOutput, nil
}
